{% extends "private/base.html" %}
{% load static %}

{% block title %}Taco - Share and find{% endblock %}
{% block content %}



<div class="container">

    <div class="row">
        <div class="col-lg-6 offset-lg-3">

            <a class="btn btn-light btn-xl" href="{% url 'petition_add' 'petition' %}">Create a
                petition</a>&nbsp;&nbsp;<a class="btn btn-light btn-xl" href="{% url 'petition_add' 'offer' %}">Create
                an offer</a>

        </div>
    </div>

    {% if petition_list %}
    <div class="row">
        {% for petition in petition_list %}
        <div class="col-lg-6 offset-lg-3">
            <a href="{% url 'petition' petition.id %}">
                <div class="cardbox shadow-lg bg-white">

                    <div class="cardbox-heading">
                        <!-- START dropdown-->
                        <div class="dropdown float-right">
                            <button class="btn btn-flat btn-flat-icon" type="button" data-toggle="dropdown"
                                aria-expanded="false">
                                <em class="fa fa-ellipsis-h"></em>
                            </button>
                            <div class="dropdown-menu dropdown-scale dropdown-menu-right" role="menu"
                                style="position: absolute; transform: translate3d(-136px, 28px, 0px); top: 0px; left: 0px; will-change: transform;">
                                <a class="dropdown-item" href="#">Hide post</a>
                                <a class="dropdown-item" href="#">Stop following</a>
                                <a class="dropdown-item" href="#">Report</a>
                            </div>
                        </div>
                        <!--/ dropdown -->
                        <div class="media m-0">
                            <div class="d-flex mr-3">
                                <a href="">
                                    {% if petition.user.avatar %}
                                    <img class="img-fluid rounded-circle" src="{{ petition.user.avatar.url }}" alt="User"></a>
                                    {% else %}
                                    <img class="img-fluid rounded-circle" src="{% static 'users/images/default.jpg' %}" alt="Image">
                                    {% endif %}
                            </div>
                            <div class="media-body">
                                <p class="m-0">{{petition.user.get_full_name}} - {{petition.user.id}}</p>
                                <small><span><i class="icon ion-md-pin"></i> Nairobi, Kenya - Petition {{petition.id}}</span></small>
                                <small><span><i class="icon ion-md-time"></i>{{ petition.start_date|timesince }}</span></small>
                            </div>
                        </div>
                        <!--/ media -->
                    </div>
                    <!--/ cardbox-heading -->

                    <div class="cardbox-item">
                        {% if petition.petition_img %}
                        <img class="img-fluid" src="{{ petition.petition_img.url }}" alt="Image">
                        {% else %}
                        <img class="img-fluid" src="{% static 'users/images/default.jpg' %}" alt="Image">
                        {% endif %}
                    </div>
                    <!--/ cardbox-item -->
                    <div class="cardbox-title">
                        <span class="mb-0">{{ petition.title }}</span>
                        <p class="text-muted">{{ petition.description|truncatewords:25 }}</p>
                    </div>
                    <div class="cardbox-base">
                        <ul class="float-right">
                            <li><a><i class="fa fa-comments"></i></a></li>
                            <li><a><em class="mr-5"><span class="applause_{{petition.id}}">{{ petition.num_applauses}}</span></em></a></li>
                            <li><a><i class="fa fa-share-alt"></i></a></li>
                            <li><a><em class="mr-3"><span>{{ petition.num_offers}}</span></em></a></li>
                        </ul>
                        <ul>
                            <li><a><i class="fa fa-thumbs-up"></i></a></li>
                            <li><a href="#"><img
                                        src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/3.jpeg"
                                        class="img-fluid rounded-circle" alt="User"></a></li>
                            <li><a href="#"><img
                                        src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/1.jpg"
                                        class="img-fluid rounded-circle" alt="User"></a></li>
                            <li><a href="#"><img
                                        src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/5.jpg"
                                        class="img-fluid rounded-circle" alt="User"></a></li>
                            <li><a href="#"><img
                                        src="http://www.themashabrand.com/templates/bootsnipp/post/assets/img/users/2.jpg"
                                        class="img-fluid rounded-circle" alt="User"></a></li>
                            <li><a><span class="joined_{{ petition.id }}">{{ petition.num_joins }}</span> joined {{petition.user.first_name}}</a></li>
                        </ul>
                    </div>
                    <!--/ cardbox-base -->
                    <div class="cardbox-comments">

                        <ul>
                            {% if petition.user.id != user.id%}
                                {% if petition.i_joined == 0 %}
                                <li class="join btn btn-info" onclick="javascript:join('{{ petition.id }}')">Join -  {{petition.i_joined}}</li>
                                {% else %}
                                <li class="join btn btn-info" onclick="javascript:leave('{{ petition.id }}')">Leave -  {{petition.i_joined}}</li>
                                {% endif %}
                                <li class="offer btn btn-info"><a
                                    href="{% url 'petition_add' 'offer' %}?petition={{petition.id}}">Offer</a></li>
                            {% endif %}
                            <li class="clap btn btn-info" data-petition="{{ petition.id }}">Applause</li>
                        </ul>

                        <!--/. Search -->
                    </div>
                    <!--/ cardbox-like -->
                </div>
                <!--/ cardbox -->
            </a>
        </div>
        <!--/ col-lg-6 -->

        <!--/ col-lg-3 -->


        {% endfor %}
    </div>

    {% else %}
    <p>There is no petitions near your position</p>
    {% endif %}


</div>
{% endblock %}

{% block extra_js %}
<script>
    var claps = 1;
    var maxTime;
    var clapTimer;
    var init;

    function join(petition_id) {


        $.ajax({
            url: '{% url "petition_join" %}',
            data: { 'petition_id': petition_id },
            type: "POST",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            dataType: 'json',
            success: function (data) {
                console.log("Enviado join " + $("span#count-join").html());
                $("span.joined_"+petition_id).html(parseInt($("span.joined_"+petition_id).html()) + 1)
                if (data.is_taken) {
                    alert("A user with this username already exists.");
                }
            }
        });
    }

    function sendApplause(petition_id) {
        clearTimeout(clapTimer);
        clearTimeout(maxTime);
        var totalTime = parseInt((Date.now() - init) / 1000);

        console.log(claps + " - " + totalTime);
        $('*[data-petition="'+petition_id+'"]').off();
        $('*[data-petition="'+petition_id+'"]').removeClass("clap");
        $.ajax({
            url: '{% url "applauses" %}',
            data: {
                'petition': petition_id,
                'claps': claps,
                'duration': totalTime,
                'intensisty': '50'
            },
            type: "POST",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            dataType: 'json',
            success: function (data) {
                $("span.applause_"+petition_id).html(parseInt($("span.applause_"+petition_id).html()) + 1)
            }
        });
    }



    $('.clap').click(function () {
        petition_id = $(this).data("petition");
        clearTimeout(clapTimer);
        if (claps == 1) {
            init = Date.now();
            maxTime = setTimeout(sendApplause, 20000, petition_id);
        }
        claps += 1;
        clapTimer = setTimeout(sendApplause, 5000, petition_id);
        console.log(claps);
    });



    function follow() {

        $.ajax({
            url: '{% url "following" %}',
            data: {
                'following_to': '{{ petition.user.id }}'
            },
            type: "POST",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            },
            dataType: 'json',
            success: function (data) {
                $("span#count-follow").html(parseInt($("span#count-follow").html()) + 1)
                console.log("Enviado following");
                if (data.is_taken) {
                }
            }
        });
    }

    $('.follow').click(function () {
        follow();
        $('.follow').off();
    });

</script>
{% endblock extra_js %}